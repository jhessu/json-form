angular.module("json-form",[]).directive("validationFile",function(){return{require:"ngModel",restrict:"A",link:function(e,n,t,a){a.$validators.file=function(e){return null==e}}}}).directive("validationUrl",["$http","$q",function(e,n){return{require:"ngModel",restrict:"A",link:function(t,a,r,i){r.validationUrl&&r.validationUrl.length>0&&(i.$asyncValidators.validationurl=function(t,a){return e.post(r.validationUrl,{validate:a}).then(function(e){return e.data.data.valid?!0:n.reject(e.data.message)})})}}}]).directive("jsonForm",function(){return{restrict:"E",require:"ngModel",templateUrl:"/views/directives/json-form.html",scope:{ngModel:"=",schema:"=formSchema",valid:"=?formValid",jsonForm:"=?formCtrl",readOnly:"@?msReadonly"},link:function(e,n,t,a){e.ngModel;e.focus={},e.disabled={},e.visible={},e.required={};var r=function(e,n,t){(null==e[n]||"undefined"==typeof e[n])&&(e[n]=t)},i=function(n){var t=/(.*)\[/,a=/\[(.*)\]$/;if(t.test(n)&&a.test(n)){var r=t.exec(n),i=a.exec(n);if(r.length>1&&i.length>1){var o=e.ngModel[r[1]];if(i=i[1],"undefined"!=typeof o&&"undefined"!=typeof i)return i==o}}return e.ngModel[n]},o=function(){_.each(e.schema,function(n,t){if("undefined"==typeof n.name&&"undefined"==typeof n.label)throw"Neither 'name' nor 'label' are defined in one of the items";"undefined"==typeof n.name&&(n.name=n.label.toLowerCase().split(" ").join("_")),"undefined"==typeof n.label&&(n.label=n.name[0].toUpperCase()+n.name.slice(1)),"immediate"==n.updateOn&&(n.updateOn="default"),r(n,"order",t),r(n,"visible",!0),r(n,"enabled",!0),r(n,"required",!1),r(n,"pattern",/(.*)$/),r(n,"feedback",!1),r(n,"validationUrl",""),r(n,"placeholder","file"==n.type?"No file chosen...":""),r(n,"minLength",""),r(n,"maxLength",""),r(n,"min",""),r(n,"max",""),r(n,"accept","*"),r(n,"options",null),r(n,"typeahead",[]),r(n,"default","checkbox"==n.type?!1:null),r(n,"rows",5),r(n,"classes",null),r(n,"helpMessage",""),r(n,"errorMessage",null),r(n,"debounce",n.validationUrl.length>0?200:0),r(n,"updateOn",n.typeahead.length>0||n.debounce>0?"default":"blur"),n.visible="true"===n.visible?!0:"false"===n.visible?!1:n.visible,n.enabled="true"===n.enabled?!0:"false"===n.enabled?!1:n.enabled,n.required="true"===n.required?!0:"false"===n.required?!1:n.required,n.pattern=new RegExp(n.pattern);try{n.errorMessage=JSON.parse(n.errorMessage)}catch(a){}try{"string"==typeof n.options&&(n.options=JSON.parse(n.options))}catch(a){n.options=null}try{"string"==typeof n.typeahead&&(n.typeahead=n.typeahead.split(","))}catch(a){n.typeahead=[]}try{"string"==typeof n.validators&&(n.validators=JSON.parse(validators))}catch(a){n.validators={}}"undefined"==typeof e.ngModel[n.name]&&null!=n["default"]&&(e.ngModel[n.name]=n["default"])})};o(),e.generatePassword=function(n){for(var t="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";t.length<10;t+=a.charAt(Math.floor(Math.random()*a.length)));e.ngModel[n.name]=t},e.isDisabled=function(n){var t="undefined"==typeof e.disabled[n.name]?n.disabled:!!e.disabled[n.name],a=e.disabled[n.name]=0==n.enabled||"string"==typeof n.enabled&&!i(n.enabled);return a?delete e.ngModel[n.name]:t!=a&&(null!=n["default"]&&(e.ngModel[n.name]=n["default"]),e.jsonForm[n.name].$setPristine()),e.disabled[n.name]},e.isVisible=function(n){var t="undefined"==typeof e.visible[n.name]?n.visible:!!e.visible[n.name],a=e.visible[n.name]=1==n.visible||"string"==typeof n.visible&&i(n.visible);return a?t!=a&&(null!=n["default"]&&(e.ngModel[n.name]=n["default"]),e.jsonForm[n.name].$setPristine()):delete e.ngModel[n.name],e.visible[n.name]},e.isRequired=function(n){var t="undefined"==typeof e.required[n.name]?n.required:!!e.required[n.name],a=e.required[n.name]=1==n.required||"string"==typeof n.required&&i(n.required);return a&&t!=a&&e.jsonForm[n.name].$setDirty(),a},e.isInput=function(e){return"text"==e.type||"password"==e.type||"password-show"==e.type||"password-generate"==e.type||"number"==e.type||"date"==e.type||"datetime-local"==e.type||"time"==e.type||"week"==e.type||"month"==e.type||"url"==e.type||"email"==e.type},e.getType=function(e){var n="password-show"==e.type||"password-generate"==e.type?"password":e.type;return e.showPassword&&"password"==n?"text":n},e.getClass=function(n){if(e.readOnly)return"";var t=[];return"string"==typeof n.classes&&n.classes.length>0&&t.push(n.classes),e.jsonForm[n.name].$invalid&&e.jsonForm[n.name].$dirty&&!e.focus[n.name]&&"file"!=n.type&&t.push(e.isRequired(n)?"has-error":"has-warning"),e.jsonForm[n.name].$pending&&e.jsonForm[n.name].$dirty&&t.push("is-pending"),e.focus[n.name]&&t.push("has-focus"),t.join(" ")},e.getError=function(n){if(null===n.errorMessage)return"";if("string"==typeof n.errorMessage)return n.errorMessage;if("object"==typeof n.errorMessage){var t=e.jsonForm[n.name].$error;for(var a in t)if(a in n.errorMessage)return n.errorMessage[a]}return""},e.readOnly="true"==e.readOnly||1==e.readOnly,e.files={},e.resetFile=function(n){delete e.ngModel[n.name]},e.hasFile=function(n){return"undefined"!=typeof e.ngModel[n.name]},e.onFileSelect=function(n,t){if(t.length>0){var a=t[0];e.ngModel[n.name]=a}},e.getFileName=function(n){var t=e.ngModel[n.name];return"string"==typeof t?t:"object"==typeof t&&null!=t?t.name||"":n.placeholder||""},e.$watch(function(){e.schema&&(e.valid=!0,Object.keys(e.schema).forEach(function(n){var t=e.schema[n],a=e.jsonForm[t.name];(e.isRequired(t)&&!e.isDisabled(t)&&e.isVisible(t)&&"undefined"!=typeof a&&a.$invalid||a.$pending)&&(e.valid=!1)}))})}}}).service("jsonForm",["$modal",function(e){return{open:function(n,t){if("object"!=typeof n)throw"Invalid schema!";var a=t||{};return a.text||(a.text={}),a.template='<div class="modal-header" ng-if="header"><h2 class="modal-title">{{ header }}</h2></div><div class="modal-body"><json-form ng-model="model" form-schema="schema" form-valid="isValid"></json-form></div><div class="modal-footer"><button class="btn btn-primary" ng-disabled="!isValid" ng-click="$close(model)" tabindex="100">{{ ok }}</button><button class="btn btn-default" ng-click="$dismiss()" tabindex="101">{{ cancel }}</button></div>',a.controller=["$scope",function(e){e.schema=n,e.model={},e.ok=a.text.ok||"Ok",e.cancel=a.text.cancel||"Cancel",e.header=a.text.header||""}],e.open(a).result}}}]);